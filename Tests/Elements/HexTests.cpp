// #define DISABLE_HEX_TESTS

#ifndef DISABLE_HEX_TESTS

#include "HexTests.h"
#include <Eigen/Eigenvalues>

TEST_F(HexTest, FF_ExactValuesAtCorners) {

    auto ff_node0 = hex->FF(-1.0, -1.0, -1.0);
    EXPECT_NEAR(std::abs(ff_node0[0]), 1.0, 1e-9) << "FF[0] at node 0 should be equal to 1.0";
    for (int i = 1; i < 8; i++) {
        EXPECT_NEAR(std::abs(ff_node0[i]), 0.0, 1e-9) << "FF[" << i << "] at node 0 should be equal to 0.0";
    }

    auto ff_node1 = hex->FF(1.0, -1.0, -1.0);
    EXPECT_NEAR(std::abs(ff_node1[1]), 1.0, 1e-9) << "FF[1] at node 1 should be equal to 1.0";
    for (int i = 0; i < 8; i++) {
        if (i != 1) EXPECT_NEAR(std::abs(ff_node1[i]), 0.0, 1e-9) << "FF[" << i << "] at node 1 should be equal to 0.0";
    }

    auto ff_node6 = hex->FF(1.0, 1.0, 1.0);
    EXPECT_NEAR(std::abs(ff_node6[6]), 1.0, 1e-9) << "FF[6] at node 6 should be equal to 1.0";
    for (int i = 0; i < 8; i++) {
        if (i != 6) EXPECT_NEAR(std::abs(ff_node6[i]), 0.0, 1e-9) << "FF[" << i << "] at node 6 should be equal to 0.0";
    }
}

TEST_F(HexTest, FF_ExactValuesAtCenter) {

    auto ff_center = hex->FF(0.0, 0.0, 0.0);
    
    const double expected = 0.125;
    for (int i = 0; i < 8; i++) {
        EXPECT_NEAR(std::abs(ff_center[i]), expected, 1e-9)
            << "FF[" << i << "] at center should be equal to " << expected;
    }
}

TEST_F(HexTest, B_ExactAllValuesAtCenter) {

    Eigen::MatrixXcd B = hex->B(0.0, 0.0, 0.0);
    
    const double expected_dN_X0 = -0.25;
    const double expected_dN_Y0 = -0.25;
    const double expected_dN_Z0 = -0.25;
    
    EXPECT_NEAR(B(0, 0).real(), expected_dN_X0, 1e-8) << "B(0,0) should be equal to " << expected_dN_X0;
    EXPECT_NEAR(B(1, 1).real(), expected_dN_Y0, 1e-8) << "B(1,1) should be equal to " << expected_dN_Y0;
    EXPECT_NEAR(B(2, 2).real(), expected_dN_Z0, 1e-8) << "B(2,2) should be equal to " << expected_dN_Z0;
    
    for (int i = 0; i < 6; i++) {
        for (int j = 0; j < 24; j++) {
            EXPECT_TRUE(std::isfinite(B(i, j).real()))
                << "B(" << i << "," << j << ") should be finite";
            EXPECT_NEAR(B(i, j).imag(), 0.0, 1e-12)
                << "B(" << i << "," << j << ") should not have imaginary part";
        }
    }
    
    EXPECT_EQ(B.rows(), 6) << "B should have 6 rows";
    EXPECT_EQ(B.cols(), 24) << "B should have 24 columns";
}

TEST_F(HexTest, localK_ExactAllMatrixValues) {

    double E = 210e9;
    double nu = 0.3;
    hex->set_constants(E, nu, 7850.0);
    
    double factor = E / ((1.0 + nu) * (1.0 - 2.0 * nu));
    hex->D = Eigen::MatrixXd::Zero(6, 6);
    hex->D(0, 0) = hex->D(1, 1) = hex->D(2, 2) = factor * (1.0 - nu);
    hex->D(0, 1) = hex->D(0, 2) = hex->D(1, 0) = hex->D(1, 2) = hex->D(2, 0) = hex->D(2, 1) = factor * nu;
    hex->D(3, 3) = hex->D(4, 4) = hex->D(5, 5) = factor * (1.0 - 2.0 * nu) / 2.0;
    
    Eigen::MatrixXcd K = hex->localK();
    
    const double K_values[24][24] = {
        {49358974358.9744, 16826923076.9231, 16826923076.9231, -22435897435.8974, 3365384615.38461, 3365384615.38462, -17948717948.7179, -16826923076.9231, 1682692307.69231, 11217948717.9487, -3365384615.38461, 8413461538.46153, 11217948717.9487, 8413461538.46154, -3365384615.38461, -17948717948.7179, 1682692307.69231, -16826923076.9231, -12339743589.7436, -8413461538.46154, -8413461538.46154, -1121794871.79487, -1682692307.69231, -1682692307.69231},
        {16826923076.9231, 49358974358.9744, 16826923076.9231, -3365384615.38462, 11217948717.9487, 8413461538.46153, -16826923076.9231, -17948717948.7179, 1682692307.69231, 3365384615.38462, -22435897435.8974, 3365384615.38461, 8413461538.46154, 11217948717.9487, -3365384615.38461, -1682692307.69231, -1121794871.79487, -1682692307.69231, -8413461538.46154, -12339743589.7436, -8413461538.46153, 1682692307.69231, -17948717948.7179, -16826923076.9231},
        {16826923076.9231, 16826923076.9231, 49358974358.9744, -3365384615.38462, 8413461538.46153, 11217948717.9487, -1682692307.69231, -1682692307.69231, -1121794871.79487, 8413461538.46153, -3365384615.38462, 11217948717.9487, 3365384615.38462, 3365384615.38461, -22435897435.8974, -16826923076.9231, 1682692307.69231, -17948717948.7179, -8413461538.46154, -8413461538.46154, -12339743589.7436, 1682692307.69231, -16826923076.9231, -17948717948.7179},
        {-22435897435.8974, -3365384615.38462, -3365384615.38462, 49358974358.9744, -16826923076.9231, -16826923076.9231, 11217948717.9487, 3365384615.38462, -8413461538.46154, -17948717948.7179, 16826923076.9231, -1682692307.69231, -17948717948.7179, -1682692307.69231, 16826923076.9231, 11217948717.9487, -8413461538.46154, 3365384615.38461, -1121794871.79487, 1682692307.69231, 1682692307.69231, -12339743589.7436, 8413461538.46154, 8413461538.46153},
        {3365384615.38461, 11217948717.9487, 8413461538.46153, -16826923076.9231, 49358974358.9744, 16826923076.9231, -3365384615.38462, -22435897435.8974, 3365384615.38462, 16826923076.9231, -17948717948.7179, 1682692307.69231, 1682692307.69231, -1121794871.79487, -1682692307.69231, -8413461538.46154, 11217948717.9487, -3365384615.38462, -1682692307.69231, -17948717948.7179, -16826923076.9231, 8413461538.46154, -12339743589.7436, -8413461538.46153},
        {3365384615.38462, 8413461538.46153, 11217948717.9487, -16826923076.9231, 16826923076.9231, 49358974358.9744, -8413461538.46154, -3365384615.38461, 11217948717.9487, 1682692307.69231, -1682692307.69231, -1121794871.79487, 16826923076.9231, 1682692307.69231, -17948717948.7179, -3365384615.38462, 3365384615.38462, -22435897435.8974, -1682692307.69231, -16826923076.9231, -17948717948.7179, 8413461538.46154, -8413461538.46154, -12339743589.7436},
        {-17948717948.7179, -16826923076.9231, -1682692307.69231, 11217948717.9487, -3365384615.38462, -8413461538.46153, 49358974358.9744, 16826923076.9231, -16826923076.9231, -22435897435.8974, 3365384615.38462, -3365384615.38461, -12339743589.7436, -8413461538.46154, 8413461538.46153, -1121794871.79487, -1682692307.69231, 1682692307.69231, 11217948717.9487, 8413461538.46154, 3365384615.38461, -17948717948.7179, 1682692307.69231, 16826923076.9231},
        {-16826923076.9231, -17948717948.7179, -1682692307.69231, 3365384615.38462, -22435897435.8974, -3365384615.38461, 16826923076.9231, 49358974358.9744, -16826923076.9231, -3365384615.38461, 11217948717.9487, -8413461538.46153, -8413461538.46154, -12339743589.7436, 8413461538.46154, 1682692307.69231, -17948717948.7179, 16826923076.9231, 8413461538.46154, 11217948717.9487, 3365384615.38461, -1682692307.69231, -1121794871.79487, 1682692307.69231},
        {1682692307.69231, 1682692307.69231, -1121794871.79487, -8413461538.46153, 3365384615.38462, 11217948717.9487, -16826923076.9231, -16826923076.9231, 49358974358.9743, 3365384615.38461, -8413461538.46153, 11217948717.9487, 8413461538.46154, 8413461538.46154, -12339743589.7436, -1682692307.69231, 16826923076.9231, -17948717948.7179, -3365384615.38461, -3365384615.38462, -22435897435.8974, 16826923076.9231, -1682692307.69231, -17948717948.7179},
        {11217948717.9487, 3365384615.38462, 8413461538.46153, -17948717948.7179, 16826923076.9231, 1682692307.69231, -22435897435.8974, -3365384615.38461, 3365384615.38461, 49358974358.9744, -16826923076.9231, 16826923076.9231, -1121794871.79487, 1682692307.69231, -1682692307.69231, -12339743589.7436, 8413461538.46154, -8413461538.46154, -17948717948.7179, -1682692307.69231, -16826923076.9231, 11217948717.9487, -8413461538.46153, -3365384615.38461},
        {-3365384615.38461, -22435897435.8974, -3365384615.38461, 16826923076.9231, -17948717948.7179, -1682692307.69231, 3365384615.38462, 11217948717.9487, -8413461538.46153, -16826923076.9231, 49358974358.9744, -16826923076.9231, -1682692307.69231, -17948717948.7179, 16826923076.9231, 8413461538.46154, -12339743589.7436, 8413461538.46154, 1682692307.69231, -1121794871.79487, 1682692307.69231, -8413461538.46153, 11217948717.9487, 3365384615.38461},
        {8413461538.46153, 3365384615.38462, 11217948717.9487, -1682692307.69231, 1682692307.69231, -1121794871.79487, -3365384615.38462, -8413461538.46153, 11217948717.9487, 16826923076.9231, -16826923076.9231, 49358974358.9744, 1682692307.69231, 16826923076.9231, -17948717948.7179, -8413461538.46154, 8413461538.46154, -12339743589.7436, -16826923076.9231, -1682692307.69231, -17948717948.7179, 3365384615.38462, -3365384615.38462, -22435897435.8974},
        {11217948717.9487, 8413461538.46154, 3365384615.38462, -17948717948.7179, 1682692307.69231, 16826923076.9231, -12339743589.7436, -8413461538.46154, 8413461538.46154, -1121794871.79487, -1682692307.69231, 1682692307.69231, 49358974358.9743, 16826923076.9231, -16826923076.9231, -22435897435.8974, 3365384615.38461, -3365384615.38461, -17948717948.7179, -16826923076.9231, -1682692307.69231, 11217948717.9487, -3365384615.38461, -8413461538.46154},
        {8413461538.46154, 11217948717.9487, 3365384615.38462, -1682692307.69231, -1121794871.79487, 1682692307.69231, -8413461538.46154, -12339743589.7436, 8413461538.46154, 1682692307.69231, -17948717948.7179, 16826923076.9231, 16826923076.9231, 49358974358.9744, -16826923076.9231, -3365384615.38462, 11217948717.9487, -8413461538.46154, -16826923076.9231, -17948717948.7179, -1682692307.69231, 3365384615.38462, -22435897435.8974, -3365384615.38462},
        {-3365384615.38461, -3365384615.38461, -22435897435.8974, 16826923076.9231, -1682692307.69231, -17948717948.7179, 8413461538.46153, 8413461538.46154, -12339743589.7436, -1682692307.69231, 16826923076.9231, -17948717948.7179, -16826923076.9231, -16826923076.9231, 49358974358.9744, 3365384615.38462, -8413461538.46154, 11217948717.9487, 1682692307.69231, 1682692307.69231, -1121794871.79487, -8413461538.46154, 3365384615.38461, 11217948717.9487},
        {-17948717948.7179, -1682692307.69231, -16826923076.9231, 11217948717.9487, -8413461538.46153, -3365384615.38462, -1121794871.79487, 1682692307.69231, -1682692307.69231, -12339743589.7436, 8413461538.46154, -8413461538.46154, -22435897435.8974, -3365384615.38461, 3365384615.38462, 49358974358.9743, -16826923076.9231, 16826923076.9231, 11217948717.9487, 3365384615.38461, 8413461538.46154, -17948717948.7179, 16826923076.9231, 1682692307.69231},
        {1682692307.69231, -1121794871.79487, 1682692307.69231, -8413461538.46153, 11217948717.9487, 3365384615.38462, -1682692307.69231, -17948717948.7179, 16826923076.9231, 8413461538.46154, -12339743589.7436, 8413461538.46154, 3365384615.38461, 11217948717.9487, -8413461538.46154, -16826923076.9231, 49358974358.9743, -16826923076.9231, -3365384615.38461, -22435897435.8974, -3365384615.38462, 16826923076.9231, -17948717948.7179, -1682692307.69231},
        {-16826923076.9231, -1682692307.69231, -17948717948.7179, 3365384615.38461, -3365384615.38462, -22435897435.8974, 1682692307.69231, 16826923076.9231, -17948717948.7179, -8413461538.46154, 8413461538.46154, -12339743589.7436, -3365384615.38461, -8413461538.46154, 11217948717.9487, 16826923076.9231, -16826923076.9231, 49358974358.9744, 8413461538.46154, 3365384615.38461, 11217948717.9487, -1682692307.69231, 1682692307.69231, -1121794871.79487},
        {-12339743589.7436, -8413461538.46154, -8413461538.46154, -1121794871.79487, -1682692307.69231, -1682692307.69231, 11217948717.9487, 8413461538.46154, -3365384615.38462, -17948717948.7179, 1682692307.69231, -16826923076.9231, -17948717948.7179, -16826923076.9231, 1682692307.69231, 11217948717.9487, -3365384615.38462, 8413461538.46154, 49358974358.9744, 16826923076.9231, 16826923076.9231, -22435897435.8974, 3365384615.38462, 3365384615.38462},
        {-8413461538.46154, -12339743589.7436, -8413461538.46154, 1682692307.69231, -17948717948.7179, -16826923076.9231, 8413461538.46154, 11217948717.9487, -3365384615.38462, -1682692307.69231, -1121794871.79487, -1682692307.69231, -16826923076.9231, -17948717948.7179, 1682692307.69231, 3365384615.38461, -22435897435.8974, 3365384615.38461, 16826923076.9231, 49358974358.9743, 16826923076.9231, -3365384615.38461, 11217948717.9487, 8413461538.46154},
        {-8413461538.46154, -8413461538.46153, -12339743589.7436, 1682692307.69231, -16826923076.9231, -17948717948.7179, 3365384615.38461, 3365384615.38461, -22435897435.8974, -16826923076.9231, 1682692307.69231, -17948717948.7179, -1682692307.69231, -1682692307.69231, -1121794871.79487, 8413461538.46154, -3365384615.38462, 11217948717.9487, 16826923076.9231, 16826923076.9231, 49358974358.9744, -3365384615.38461, 8413461538.46154, 11217948717.9487},
        {-1121794871.79487, 1682692307.69231, 1682692307.69231, -12339743589.7436, 8413461538.46154, 8413461538.46154, -17948717948.7179, -1682692307.69231, 16826923076.9231, 11217948717.9487, -8413461538.46154, 3365384615.38462, 11217948717.9487, 3365384615.38462, -8413461538.46154, -17948717948.7179, 16826923076.9231, -1682692307.69231, -22435897435.8974, -3365384615.38462, -3365384615.38462, 49358974358.9743, -16826923076.9231, -16826923076.9231},
        {-1682692307.69231, -17948717948.7179, -16826923076.9231, 8413461538.46154, -12339743589.7436, -8413461538.46154, 1682692307.69231, -1121794871.79487, -1682692307.69231, -8413461538.46154, 11217948717.9487, -3365384615.38462, -3365384615.38462, -22435897435.8974, 3365384615.38462, 16826923076.9231, -17948717948.7179, 1682692307.69231, 3365384615.38462, 11217948717.9487, 8413461538.46154, -16826923076.9231, 49358974358.9743, 16826923076.9231},
        {-1682692307.69231, -16826923076.9231, -17948717948.7179, 8413461538.46154, -8413461538.46154, -12339743589.7436, 16826923076.9231, 1682692307.69231, -17948717948.7179, -3365384615.38462, 3365384615.38462, -22435897435.8974, -8413461538.46154, -3365384615.38462, 11217948717.9487, 1682692307.69231, -1682692307.69231, -1121794871.79487, 3365384615.38462, 8413461538.46154, 11217948717.9487, -16826923076.9231, 16826923076.9231, 49358974358.9743}
    };
    
    for (int i = 0; i < 24; i++) {
        for (int j = 0; j < 24; j++) {
            const double expected = K_values[i][j];
            EXPECT_NEAR(K(i, j).real(), expected, std::abs(expected) * 1e-6)
                << "K(" << i << "," << j << ") should be equal to " << expected;
            EXPECT_NEAR(K(i, j).imag(), 0.0, 1e-12)
                << "K(" << i << "," << j << ") should not have imaginary part";
        }
    }
    
    for (int i = 0; i < 24; i++) {
        for (int j = 0; j < 24; j++) {
            EXPECT_NEAR(K(i, j).real(), K(j, i).real(), std::abs(K(i, j).real()) * 1e-10)
                << "K is not symmetric at position (" << i << "," << j << ")";
        }
    }
    
    for (int i = 0; i < 24; i++) {
        EXPECT_GT(K(i, i).real(), 0.0)
            << "Diagonal element K(" << i << "," << i << ") should be positive";
    }
    
    Eigen::SelfAdjointEigenSolver<Eigen::MatrixXd> solver(K.real());
    for (int i = 0; i < 24; i++) {
        EXPECT_GT(solver.eigenvalues()(i), 0.0)
            << "Eigenvalue " << i << " should be positive";
    }
}

TEST_F(HexTest, localF_ExactAllValues) {

    double pressure_value = 1000.0;
    hex->set_load(PRESSURE, 0, {pressure_value, 0, 0, 0, 0, 0});
    
    std::vector<double> F = hex->localF();
    
    EXPECT_EQ(F.size(), 24) << "Vector size F should be 24";
    
    double total_force = 0.0;
    for (int i = 0; i < 24; i++) {
        total_force += std::abs(F[i]);
    }
    EXPECT_GT(total_force, 0.0) << "Total load should be positive";
    
    const double F_expected[24] = {
        0.0, 0.0, 250.0, 0.0, 0.0, 250.0, 0.0, 0.0, 250.0, 0.0, 0.0, 250.0,
        0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0
    };
    
    for (int i = 0; i < 24; i++) {
        const double expected = F_expected[i];
        EXPECT_NEAR(F[i], expected, std::abs(expected) * 1e-6)
            << "F[" << i << "] should be equal to " << expected;
        EXPECT_TRUE(std::isfinite(F[i])) << "F[" << i << "] should be finite";
    }
    
    const double expected_total = 1000.0;
    EXPECT_NEAR(total_force, expected_total, 1e-6) 
        << "Total load should be equal to " << expected_total;
}

TEST_F(HexTest, localC_ExactAllMatrixValues) {

    Eigen::MatrixXd C = hex->localC();
    
    const double C_values[8][8] = {
        {0.037037037037037, 0.0185185185185185, 0.00925925925925925, 0.0185185185185185, 0.0185185185185185, 0.00925925925925925, 0.00462962962962963, 0.00925925925925925},
        {0.0185185185185185, 0.037037037037037, 0.0185185185185185, 0.00925925925925925, 0.00925925925925925, 0.0185185185185185, 0.00925925925925925, 0.00462962962962963},
        {0.00925925925925925, 0.0185185185185185, 0.037037037037037, 0.0185185185185185, 0.00462962962962963, 0.00925925925925925, 0.0185185185185185, 0.00925925925925925},
        {0.0185185185185185, 0.00925925925925925, 0.0185185185185185, 0.037037037037037, 0.00925925925925925, 0.00462962962962963, 0.00925925925925925, 0.0185185185185185},
        {0.0185185185185185, 0.00925925925925925, 0.00462962962962963, 0.00925925925925925, 0.037037037037037, 0.0185185185185185, 0.00925925925925925, 0.0185185185185185},
        {0.00925925925925925, 0.0185185185185185, 0.00925925925925925, 0.00462962962962963, 0.0185185185185185, 0.037037037037037, 0.0185185185185185, 0.00925925925925925},
        {0.00462962962962963, 0.00925925925925925, 0.0185185185185185, 0.00925925925925925, 0.00925925925925925, 0.0185185185185185, 0.037037037037037, 0.0185185185185185},
        {0.00925925925925925, 0.00462962962962963, 0.00925925925925925, 0.0185185185185185, 0.0185185185185185, 0.00925925925925925, 0.0185185185185185, 0.037037037037037}
    };
    
    for (int i = 0; i < 8; i++) {
        for (int j = 0; j < 8; j++) {
            const double expected = C_values[i][j];
            EXPECT_NEAR(C(i, j), expected, std::abs(expected) * 1e-10)
                << "C(" << i << "," << j << ") should be equal to " << expected;
        }
    }
    
    for (int i = 0; i < 8; i++) {
        for (int j = 0; j < 8; j++) {
            EXPECT_NEAR(C(i, j), C(j, i), 1e-12)
                << "C is not symmetric at position (" << i << "," << j << ")";
        }
    }
    
    for (int i = 0; i < 8; i++) {
        for (int j = 0; j < 8; j++) {
            EXPECT_GT(C(i, j), 0.0)
                << "C(" << i << "," << j << ") should be positive";
        }
    }
}

TEST_F(HexTest, localR_ExactAllValues) {

    std::vector<double> values(8, 1.0);
    std::vector<double> R = hex->localR(values);
    
    const double expected = 0.125;
    
    EXPECT_EQ(R.size(), 8) << "Vector size R should be 8";
    for (int i = 0; i < 8; i++) {
        EXPECT_NEAR(R[i], expected, 1e-12)
            << "R[" << i << "] should be equal to " << expected;
    }
    
    for (int i = 0; i < 8; i++) {
        EXPECT_GT(R[i], 0.0) << "R[" << i << "] should be positive";
    }
}

TEST_F(HexTest, localM_ExactAllMatrixValues) {

    Eigen::MatrixXcd M = hex->localM();
    
    const double expected_diag = 122.65625;
    
    const double M_values[24][24] = {
        {290.740740740741, 0.0, 0.0, 145.37037037037, 0.0, 0.0, 72.6851851851851, 0.0, 0.0, 145.37037037037, 0.0, 0.0, 145.37037037037, 0.0, 0.0, 72.6851851851851, 0.0, 0.0, 36.3425925925926, 0.0, 0.0, 72.6851851851851, 0.0, 0.0},
        {0.0, 290.740740740741, 0.0, 0.0, 145.37037037037, 0.0, 0.0, 72.6851851851851, 0.0, 0.0, 145.37037037037, 0.0, 0.0, 145.37037037037, 0.0, 0.0, 72.6851851851851, 0.0, 0.0, 36.3425925925926, 0.0, 0.0, 72.6851851851851, 0.0},
        {0.0, 0.0, 290.740740740741, 0.0, 0.0, 145.37037037037, 0.0, 0.0, 72.6851851851851, 0.0, 0.0, 145.37037037037, 0.0, 0.0, 145.37037037037, 0.0, 0.0, 72.6851851851851, 0.0, 0.0, 36.3425925925926, 0.0, 0.0, 72.6851851851851},
        {145.37037037037, 0.0, 0.0, 290.740740740741, 0.0, 0.0, 145.37037037037, 0.0, 0.0, 72.6851851851851, 0.0, 0.0, 72.6851851851851, 0.0, 0.0, 145.37037037037, 0.0, 0.0, 72.6851851851851, 0.0, 0.0, 36.3425925925926, 0.0, 0.0},
        {0.0, 145.37037037037, 0.0, 0.0, 290.740740740741, 0.0, 0.0, 145.37037037037, 0.0, 0.0, 72.6851851851851, 0.0, 0.0, 72.6851851851851, 0.0, 0.0, 145.37037037037, 0.0, 0.0, 72.6851851851851, 0.0, 0.0, 36.3425925925926, 0.0},
        {0.0, 0.0, 145.37037037037, 0.0, 0.0, 290.740740740741, 0.0, 0.0, 145.37037037037, 0.0, 0.0, 72.6851851851851, 0.0, 0.0, 72.6851851851851, 0.0, 0.0, 145.37037037037, 0.0, 0.0, 72.6851851851851, 0.0, 0.0, 36.3425925925926},
        {72.6851851851851, 0.0, 0.0, 145.37037037037, 0.0, 0.0, 290.740740740741, 0.0, 0.0, 145.37037037037, 0.0, 0.0, 36.3425925925926, 0.0, 0.0, 72.6851851851851, 0.0, 0.0, 145.37037037037, 0.0, 0.0, 72.6851851851851, 0.0, 0.0},
        {0.0, 72.6851851851851, 0.0, 0.0, 145.37037037037, 0.0, 0.0, 290.740740740741, 0.0, 0.0, 145.37037037037, 0.0, 0.0, 36.3425925925926, 0.0, 0.0, 72.6851851851851, 0.0, 0.0, 145.37037037037, 0.0, 0.0, 72.6851851851851, 0.0},
        {0.0, 0.0, 72.6851851851851, 0.0, 0.0, 145.37037037037, 0.0, 0.0, 290.740740740741, 0.0, 0.0, 145.37037037037, 0.0, 0.0, 36.3425925925926, 0.0, 0.0, 72.6851851851851, 0.0, 0.0, 145.37037037037, 0.0, 0.0, 72.6851851851851},
        {145.37037037037, 0.0, 0.0, 72.6851851851851, 0.0, 0.0, 145.37037037037, 0.0, 0.0, 290.740740740741, 0.0, 0.0, 72.6851851851851, 0.0, 0.0, 36.3425925925926, 0.0, 0.0, 72.6851851851851, 0.0, 0.0, 145.37037037037, 0.0, 0.0},
        {0.0, 145.37037037037, 0.0, 0.0, 72.6851851851851, 0.0, 0.0, 145.37037037037, 0.0, 0.0, 290.740740740741, 0.0, 0.0, 72.6851851851851, 0.0, 0.0, 36.3425925925926, 0.0, 0.0, 72.6851851851851, 0.0, 0.0, 145.37037037037, 0.0},
        {0.0, 0.0, 145.37037037037, 0.0, 0.0, 72.6851851851851, 0.0, 0.0, 145.37037037037, 0.0, 0.0, 290.740740740741, 0.0, 0.0, 72.6851851851851, 0.0, 0.0, 36.3425925925926, 0.0, 0.0, 72.6851851851851, 0.0, 0.0, 145.37037037037},
        {145.37037037037, 0.0, 0.0, 72.6851851851851, 0.0, 0.0, 36.3425925925926, 0.0, 0.0, 72.6851851851851, 0.0, 0.0, 290.740740740741, 0.0, 0.0, 145.37037037037, 0.0, 0.0, 72.6851851851851, 0.0, 0.0, 145.37037037037, 0.0, 0.0},
        {0.0, 145.37037037037, 0.0, 0.0, 72.6851851851851, 0.0, 0.0, 36.3425925925926, 0.0, 0.0, 72.6851851851851, 0.0, 0.0, 290.740740740741, 0.0, 0.0, 145.37037037037, 0.0, 0.0, 72.6851851851851, 0.0, 0.0, 145.37037037037, 0.0},
        {0.0, 0.0, 145.37037037037, 0.0, 0.0, 72.6851851851851, 0.0, 0.0, 36.3425925925926, 0.0, 0.0, 72.6851851851851, 0.0, 0.0, 290.740740740741, 0.0, 0.0, 145.37037037037, 0.0, 0.0, 72.6851851851851, 0.0, 0.0, 145.37037037037},
        {72.6851851851851, 0.0, 0.0, 145.37037037037, 0.0, 0.0, 72.6851851851851, 0.0, 0.0, 36.3425925925926, 0.0, 0.0, 145.37037037037, 0.0, 0.0, 290.740740740741, 0.0, 0.0, 145.37037037037, 0.0, 0.0, 72.6851851851851, 0.0, 0.0},
        {0.0, 72.6851851851851, 0.0, 0.0, 145.37037037037, 0.0, 0.0, 72.6851851851851, 0.0, 0.0, 36.3425925925926, 0.0, 0.0, 145.37037037037, 0.0, 0.0, 290.740740740741, 0.0, 0.0, 145.37037037037, 0.0, 0.0, 72.6851851851851, 0.0},
        {0.0, 0.0, 72.6851851851851, 0.0, 0.0, 145.37037037037, 0.0, 0.0, 72.6851851851851, 0.0, 0.0, 36.3425925925926, 0.0, 0.0, 145.37037037037, 0.0, 0.0, 290.740740740741, 0.0, 0.0, 145.37037037037, 0.0, 0.0, 72.6851851851851},
        {36.3425925925926, 0.0, 0.0, 72.6851851851851, 0.0, 0.0, 145.37037037037, 0.0, 0.0, 72.6851851851851, 0.0, 0.0, 72.6851851851851, 0.0, 0.0, 145.37037037037, 0.0, 0.0, 290.740740740741, 0.0, 0.0, 145.37037037037, 0.0, 0.0},
        {0.0, 36.3425925925926, 0.0, 0.0, 72.6851851851851, 0.0, 0.0, 145.37037037037, 0.0, 0.0, 72.6851851851851, 0.0, 0.0, 72.6851851851851, 0.0, 0.0, 145.37037037037, 0.0, 0.0, 290.740740740741, 0.0, 0.0, 145.37037037037, 0.0},
        {0.0, 0.0, 36.3425925925926, 0.0, 0.0, 72.6851851851851, 0.0, 0.0, 145.37037037037, 0.0, 0.0, 72.6851851851851, 0.0, 0.0, 72.6851851851851, 0.0, 0.0, 145.37037037037, 0.0, 0.0, 290.740740740741, 0.0, 0.0, 145.37037037037},
        {72.6851851851851, 0.0, 0.0, 36.3425925925926, 0.0, 0.0, 72.6851851851851, 0.0, 0.0, 145.37037037037, 0.0, 0.0, 145.37037037037, 0.0, 0.0, 72.6851851851851, 0.0, 0.0, 145.37037037037, 0.0, 0.0, 290.740740740741, 0.0, 0.0},
        {0.0, 72.6851851851851, 0.0, 0.0, 36.3425925925926, 0.0, 0.0, 72.6851851851851, 0.0, 0.0, 145.37037037037, 0.0, 0.0, 145.37037037037, 0.0, 0.0, 72.6851851851851, 0.0, 0.0, 145.37037037037, 0.0, 0.0, 290.740740740741, 0.0},
        {0.0, 0.0, 72.6851851851851, 0.0, 0.0, 36.3425925925926, 0.0, 0.0, 72.6851851851851, 0.0, 0.0, 145.37037037037, 0.0, 0.0, 145.37037037037, 0.0, 0.0, 72.6851851851851, 0.0, 0.0, 145.37037037037, 0.0, 0.0, 290.740740740741}
    };
    
    for (int i = 0; i < 24; i++) {
        for (int j = 0; j < 24; j++) {
            const double expected = M_values[i][j];
            EXPECT_NEAR(M(i, j).real(), expected, std::abs(expected) * 1e-6)
                << "M(" << i << "," << j << ") should be equal to " << expected;
            EXPECT_NEAR(M(i, j).imag(), 0.0, 1e-12)
                << "M(" << i << "," << j << ") should not have imaginary part";
        }
    }
    
    for (int i = 0; i < 24; i++) {
        for (int j = 0; j < 24; j++) {
            EXPECT_NEAR(M(i, j).real(), M(j, i).real(), std::abs(M(i, j).real()) * 1e-10)
                << "M is not symmetric at position (" << i << "," << j << ")";
        }
    }
    
    for (int i = 0; i < 24; i++) {
        EXPECT_GT(M(i, i).real(), 0.0)
            << "Diagonal element M(" << i << "," << i << ") should be positive";
    }
    
    Eigen::SelfAdjointEigenSolver<Eigen::MatrixXd> solver(M.real());
    for (int i = 0; i < 24; i++) {
        EXPECT_GT(solver.eigenvalues()(i), 0.0)
            << "Eigenvalue " << i << " should be positive";
    }
}

TEST_F(HexTest, Volume_ExactValue) {

    double volume = hex->Volume();
    const double expected = 1.0;
    EXPECT_DOUBLE_EQ(volume, expected) << "Volume should be equal to " << expected;
}

#endif
